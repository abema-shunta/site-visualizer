var activeDate,c,calcLinkStroke,calcLinkWidth,calcNodeSize,considerFixedPosition,d3link,d3node,displayDetail,formatDate,getMax,height,isAllowedOpenDetail,linkMax,links,nodeMax,nodes,openDetail,prepareOpenDetail,preventOpenDetail,resetActiveNode,svg,width;width=window.innerWidth;height=window.innerHeight-120;activeDate=new Date;formatDate=function(d){return d.getFullYear()+"_"+("0"+(d.getMonth()+1)).slice(-2)+"_"+("0"+d.getDate()).slice(-2)};svg=d3.select("svg");svg.attr("width",width);svg.attr("height",height);links=void 0;nodes=void 0;d3link=void 0;d3node=void 0;nodeMax=void 0;linkMax=void 0;calcNodeSize=function(d){return 5+35*(d.volume/nodeMax)};calcLinkWidth=function(d){return.1+d.volume/linkMax};calcLinkStroke=function(d){var col;col="#FFF";if(d.source.etype==="start"||d.target.etype==="start"){col="#0F0"}if(d.target.etype==="end"||d.source.etype==="end"){col="#F00"}return col};getMax=function(items){var max;max=0;items.forEach(function(i){var vol;if((vol=parseInt(i.volume))>max){return max=vol}});return max};considerFixedPosition=function(d){if(d.etype==="start"){d.x=20;return d.y=20}else if(d.etype==="end"){d.x=width-20;return d.y=height-20}};d3.csv("csv/GenerateLinksForSiteVisualization_"+formatDate(activeDate)+".csv",function(link_error,_links){var self_directed_links;if(link_error){throw link_error}links=_links;self_directed_links=links.filter(function(e,i,a){return e.source===e.target});links=links.filter(function(e,i,a){return e.source!==e.target});linkMax=getMax(links);return d3.csv("csv/GenerateNodesForSiteVisualization_"+formatDate(activeDate)+".csv",function(node_error,_nodes){var d3links,d3nodes,dragended,dragged,dragstarted,simulation,ticked;if(node_error){throw node_error}nodes=_nodes;nodeMax=getMax(nodes);simulation=d3.forceSimulation().force("link",d3.forceLink().id(function(d){return d.id})).force("charge",d3.forceManyBody()).force("center",d3.forceCenter(width/2,height/2)).force("collide",d3.forceCollide().radius(calcNodeSize).iterations(2));simulation.velocityDecay(.8);simulation.alphaDecay(.001);dragstarted=function(d){if(!d3.event.active){simulation.alphaTarget(.3).restart()}d.fx=d.x;d.fy=d.y};dragged=function(d){d.fx=d3.event.x;d.fy=d3.event.y};dragended=function(d){if(!d3.event.active){simulation.alphaTarget(0)}d.fx=null;d.fy=null};d3links=svg.append("g").attr("class","links").selectAll("line").data(links).enter().append("line").attr("stroke-width",3).attr("opacity",calcLinkWidth);d3nodes=svg.append("g").attr("class","nodes").selectAll("circle").data(nodes).enter().append("circle").attr("r",calcNodeSize).attr("fill",function(d){if(d.cv_count>0){return"#FF0"}else{return"#FFF"}}).on("mouseover",function(d){return displayDetail(d.path,d.title,d.volume,d.id)}).call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));ticked=function(){nodes.forEach(considerFixedPosition);d3links.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y});return d3nodes.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y})};simulation.nodes(nodes).on("tick",ticked);simulation.force("link").links(links).distance(function(d){return(linkMax-d.volume)/linkMax*300+10}).strength(.3);return d3links.attr("stroke",calcLinkStroke)})});isAllowedOpenDetail=false;resetActiveNode=function(){var activeNode;return activeNode=null};c=function(t){return console.log(t)};openDetail=function(path){c("openDetail");if(isAllowedOpenDetail){return window.open().location.href="http://"+path}};prepareOpenDetail=function(){c("prepareOpenDetail");return isAllowedOpenDetail=true};preventOpenDetail=function(){c("preventOpenDetail");return isAllowedOpenDetail=false};displayDetail=function(path,title,volume,id){var activeNode,detail_panel,path_elm,title_elm,vol_elm;c("displayDetail");activeNode=id;detail_panel=document.querySelector("#detail_panel");title_elm=detail_panel.querySelector(".title");title_elm.textContent=title;path_elm=detail_panel.querySelector(".path");path_elm.setAttribute("href","http://"+path);path_elm.textContent=path;vol_elm=detail_panel.querySelector(".volume");return vol_elm.textContent=volume};